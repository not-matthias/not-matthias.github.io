<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://not-matthias.github.io name=base><title>
            
                Pre-commit deleted all unstaged files
            
        </title><meta content="Pre-commit deleted all unstaged files" property=og:title><link href=https://not-matthias.github.io/fonts.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=/syntax-theme-dark.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=/syntax-theme-light.css rel=stylesheet><script data-host-url=https://api-gateway.umami.dev/ data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e defer src=/js/imamu.js></script><script async data-goatcounter=https://not-matthias.goatcounter.com/count src=https://not-matthias.github.io/js/count.js></script><noscript><img src="https://not-matthias.goatcounter.com//count?p=/posts/pre-commit-lost-files/&t=Pre-commit deleted all unstaged files"></noscript><link title="
    not-matthias
" href=https://not-matthias.github.io/atom.xml rel=alternate type=application/atom+xml><link title="
    not-matthias
" href=https://not-matthias.github.io/rss.xml rel=alternate type=application/rss+xml><link href=https://not-matthias.github.io/theme/light.css rel=stylesheet><link href=https://not-matthias.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://not-matthias.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://not-matthias.github.io/main.css media=screen rel=stylesheet><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://not-matthias.github.io>not-matthias</a><div class=socials><a rel="'me'" class=social href=https://twitter.com/not_matthias> <img alt=twitter src=https://not-matthias.github.io/icons/social/twitter.svg> </a><a rel="'me'" class=social href=https://github.com/not-matthias/> <img alt=github src=https://not-matthias.github.io/icons/social/github.svg> </a><a rel="'me'" class=social href=/atom.xml> <img alt=rss src=https://not-matthias.github.io/icons/social/rss.svg> </a></div></div><div class=right-nav><a href=https://not-matthias.github.io/posts style=margin-right:.5em>/posts</a><a href=https://not-matthias.github.io/projects style=margin-right:.5em>/projects</a><a href=https://not-matthias.github.io/talks style=margin-right:.5em>/talks</a><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://not-matthias.github.io/icons/sun.svg> <img alt=Dark id=moon-icon src=https://not-matthias.github.io/icons/moon.svg style=filter:invert()> <img alt=Auto id=auto-icon src=https://not-matthias.github.io/icons/auto.svg style=filter:invert()> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>Pre-commit deleted all unstaged files</div><div class=meta>Posted on <time>2025-11-22</time><span class=tags-label>::</span><span class=tags> <a class=post-tag href=https://not-matthias.github.io/tags/bug/>bug</a> <a class=post-tag href=https://not-matthias.github.io/tags/debugging/>debugging</a> <a class=post-tag href=https://not-matthias.github.io/tags/git/>git</a> </span></div></div><section class=body><p>I was working on a new feature at $JOB and wanted to commit my changes from the last hour. I staged a few files, entered the commit message, committed them and waited for the pre-commit hooks to pass.<p>Unfortunately, the pre-commit hooks didn't pass because I had some style issues. And since I was using VSCode, I closed the dialog thinking that I just have to run <code>cargo fmt</code> once more. Then I realized that all my non-staged files were deleted.<h1 id=how-to-restore-those-files>How to restore those files?</h1><p><strong>Attempt 1: Git Stash/Reflog</strong> - I didn't exactly know what <code>pre-commit</code> was doing, so I thought that maybe they are just stashing the unstaged files like you can do with the <code>git stash --keep-index</code> command. Unfortunately, I didn't find any new stash entries. Becoming a bit nervous, I also wanted to double check if there was a reflog entry for the deleted files. However, I couldn't find any reflog entries either.<p><strong>Attempt 2: VSCode File History</strong> - There's a really useful command in VSCode called <code>Local History: Find Entry to Restore</code> which keeps track of all the file changes. This would have allowed me to restore all my files, but I was using <a href=https://zed.dev>Zed</a> at the time which doesn't have this feature.<p><strong>Attempt 3: Claude Session</strong>: I was using Claude to spec parts of the feature and do simple refactorings, so I was hoping it still had some of the file content in the conversation history. This approach worked, but it was mostly outdated and didn't contain all my lost files. Since I didn't want to rely on the CLI, I went into the <code>~/.claude</code> directory to search for parts of the content. There I discovered that its also storing a backup of each file in the <code>~/.claude/file-history</code> folder which you can search through. Unfortunately, this also only contained outdated content.<p><strong>Attempt 4: Pre-commit Cache</strong>: After I finished restoring parts of my content with Claude, I wanted to commit the changes ASAP to not lose them again. This time, I was using the <code>git</code> CLI which failed again, losing all my changes...again. Luckily, this time I had the full logs of what went wrong.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> git commit<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>amend</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>no-edit</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[WARNING]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Unstaged files detected.</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[INFO]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Stashing unstaged files to /home/not-matthias/.cache/pre-commit/patch1763743901-1677171.</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">trim</span></span><span class="z-meta z-function-call z-arguments z-shell"> trailing whitespace.................................................Passed</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fix</span></span><span class="z-meta z-function-call z-arguments z-shell"> end of files.........................................................Passed</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">check</span></span><span class="z-meta z-function-call z-arguments z-shell"> yaml...........................................(no files to check</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Skipped</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">check</span></span><span class="z-meta z-function-call z-arguments z-shell"> toml...............................................................Passed</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">check</span></span><span class="z-meta z-function-call z-arguments z-shell"> for added large files..............................................Passed</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fmt..................................................</span></span><span class="z-meta z-function-call z-arguments z-shell">(no files to check</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Skipped</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cargo</span></span><span class="z-meta z-function-call z-arguments z-shell"> check..........................................(no files to check</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Skipped</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">clippy...............................................</span></span><span class="z-meta z-function-call z-arguments z-shell">(no files to check</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Skipped</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[WARNING]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Stashed changes conflicted with hook auto-fixes... Rolling back fixes...</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">An</span></span><span class="z-meta z-function-call z-arguments z-shell"> unexpected error has occurred: CalledProcessError: command: (<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>/nix/store/639k78iljhfmciklnivi0wja8jcy788g-git-2.50.1/libexec/git-core/git<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>-c<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>core.autocrlf=false<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>apply<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>--whitespace=nowarn<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>/home/not-matthias/.cache/pre-commit/patch1763743901-1677171<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span></span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-keyword z-control z-flow z-return z-shell">return</span></span><span class="z-meta z-function-call z-arguments z-shell"> code: 1</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">stdout:</span></span><span class="z-meta z-function-call z-arguments z-shell"> (none</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">stderr:</span></span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> patch failed: src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__perf_map__tests__ld_linux_symbols.snap:1</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__perf_map__tests__ld_linux_symbols.snap: patch does not apply</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> patch failed: src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__cpp_unwind_data.snap:1</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__cpp_unwind_data.snap: patch does not apply</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> patch failed: src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__golang_unwind_data.snap:1</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__golang_unwind_data.snap: patch does not apply</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> patch failed: src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__ruff_unwind_data.snap:1</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__ruff_unwind_data.snap: patch does not apply</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> patch failed: src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__rust_divan_unwind_data.snap:1</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__rust_divan_unwind_data.snap: patch does not apply</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> patch failed: src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__the_algorithms_unwind_data.snap:1</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__the_algorithms_unwind_data.snap: patch does not apply</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Check</span></span><span class="z-meta z-function-call z-arguments z-shell"> the log at /home/not-matthias/.cache/pre-commit/pre-commit.log</span>
</span></code></pre><p>The most important line is this, which pointed me to the cache of pre-commit:<pre class=z-code><code><span class="z-text z-plain">[INFO] Stashing unstaged files to /home/not-matthias/.cache/pre-commit/patch1763743901-1677171.
</span></code></pre><p>Looking at the file, I could see that this is just a git diff that was written to a file. We can restore it easily with the <code>patch</code> command:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> patch<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p1</span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span> /home/not-matthias/.cache/pre-commit/patch1763742759-1588111</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patching</span></span><span class="z-meta z-function-call z-arguments z-shell"> file crates/heaptrack/Cargo.toml</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patching</span></span><span class="z-meta z-function-call z-arguments z-shell"> file crates/heaptrack/src/bpf.rs</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patching</span></span><span class="z-meta z-function-call z-arguments z-shell"> file crates/heaptrack/src/events.rs</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patching</span></span><span class="z-meta z-function-call z-arguments z-shell"> file crates/heaptrack/src/main.rs</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patching</span></span><span class="z-meta z-function-call z-arguments z-shell"> file crates/runner-shared/src/lib.rs</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patching</span></span><span class="z-meta z-function-call z-arguments z-shell"> file flake.nix</span>
</span></code></pre><h1 id=why-did-i-fail>Why did I fail?</h1><p>I also managed to find the root cause of the <code>pre-commit</code> failure. For some reason, some test snapshots which should be stored in Git LFS weren't stored correctly. This even makes <code>git stash</code> fail:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> git stash</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Saved</span></span><span class="z-meta z-function-call z-arguments z-shell"> working directory and index state WIP on cod-1670-runner-profile-memory-of-command: bb882e9 fixup: runner-shared</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Encountered</span></span><span class="z-meta z-function-call z-arguments z-shell"> 6 files that should have been pointers, but weren<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>t:
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">        src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__perf_map__tests__ld_linux_symbols.snap
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">        src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__cpp_unwind_data.snap
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">        src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__golang_unwind_data.snap
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">        src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__ruff_unwind_data.snap
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">        src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__rust_divan_unwind_data.snap
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">        src/run/runner/wall_time/perf/snapshots/codspeed__run__runner__wall_time__perf__unwind_data__tests__the_algorithms_unwind_data.snap
</span></span></span></code></pre><p>To fix it, I had to run <code>git lfs migrate import --fixup</code> which resolved the issue. Then the <code>pre-commit</code> hook worked correctly again as well.<h1 id=conclusion>Conclusion</h1><p>I just wanted to write about this in case anyone else encounters the same issue. There are quite a few tricks to recover lost files nowadays, because many tools are copying them and storing them <em>somewhere</em>. For example, a colleague at work lost his ZSH history, but managed to recover it since he was using <a href=https://aws.amazon.com/q/>Amazon Q</a> which sent his history to the cloud, but also kept a local copy.<p>So I guess it's time to thanks all the companies that collect and sell our data, as long as they store it locally so that we can use it for backups.</section></article></main></div></div><div class=right-content></div>